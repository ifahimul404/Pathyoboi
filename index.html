<!DOCTYPE html>
<html lang="bn" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>সুরক্ষিত ই-লাইব্রেরি</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- PDF.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <script>
        // Worker setup for PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        /* Custom Scrollbar for better look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; 
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; 
        }
        
        /* Hide render area initially until file loads */
        .hidden-ui {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen flex flex-col overflow-hidden font-sans">

    <!-- Header / Toolbar -->
    <header class="h-14 bg-gray-800 border-b border-gray-700 flex items-center justify-between px-4 shadow-md z-30">
        <div class="flex items-center gap-3">
            <i class="ph ph-file-pdf text-red-500 text-2xl"></i>
            <h1 class="text-lg font-semibold hidden sm:block">PDF Viewer Pro</h1>
        </div>

        <div class="flex items-center gap-2 bg-gray-700 rounded-lg p-1">
            <button id="prev-page" class="p-2 hover:bg-gray-600 rounded-md disabled:opacity-50 disabled:cursor-not-allowed" title="Previous Page">
                <i class="ph ph-caret-left text-lg"></i>
            </button>
            <span class="text-sm px-2">
                Page <span id="page-num" class="font-mono font-bold">--</span> / <span id="page-count" class="font-mono">--</span>
            </span>
            <button id="next-page" class="p-2 hover:bg-gray-600 rounded-md disabled:opacity-50 disabled:cursor-not-allowed" title="Next Page">
                <i class="ph ph-caret-right text-lg"></i>
            </button>
        </div>

        <div class="flex items-center gap-3">
            <div class="hidden md:flex items-center gap-1 bg-gray-700 rounded-lg p-1">
                <button id="zoom-out" class="p-2 hover:bg-gray-600 rounded-md">
                    <i class="ph ph-minus text-lg"></i>
                </button>
                <span id="zoom-level" class="text-sm w-12 text-center">100%</span>
                <button id="zoom-in" class="p-2 hover:bg-gray-600 rounded-md">
                    <i class="ph ph-plus text-lg"></i>
                </button>
            </div>
            
            <label for="file-upload" class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors flex items-center gap-2">
                <i class="ph ph-upload-simple"></i>
                <span class="hidden sm:inline">Upload PDF</span>
            </label>
            <input id="file-upload" type="file" accept="application/pdf" class="hidden" />
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 relative flex overflow-hidden">
        
        <!-- Empty State -->
        <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 z-0">
            <i class="ph ph-files text-6xl mb-4 opacity-50"></i>
            <p class="text-xl">পিডিএফ দেখতে ফাইল আপলোড করুন</p>
            <p class="text-sm mt-2 opacity-70">সুপার শার্প রেন্ডারিং সাপোর্টেড</p>
        </div>

        <!-- PDF Render Area (আপনার দেওয়া স্ট্রাকচার মডিফাইড) -->
        <div id="viewer-container" class="flex-1 relative bg-gray-800 flex flex-col items-center w-full h-full overflow-hidden hidden-ui"> 
            
            <!-- Scrollable Container -->
            <div class="w-full h-full overflow-auto flex justify-center items-start py-8 px-4 scroll-smooth" id="pdf-scroll-container">
                
                <div class="relative shadow-2xl">
                    <!-- The Canvas -->
                    <canvas id="pdf-render" class="block bg-white"></canvas>
                    
                    <!-- Watermark -->
                    <div class="absolute inset-0 pointer-events-none flex items-center justify-center opacity-[0.08] z-10 overflow-hidden">
                        <div class="transform -rotate-45 whitespace-nowrap text-gray-900 font-black text-4xl md:text-7xl border-4 border-gray-900 p-4 rounded mix-blend-multiply">
                            PREVIEW MODE
                        </div>
                    </div>

                    <!-- Loading Spinner Overlay -->
                    <div id="page-loader" class="absolute inset-0 flex items-center justify-center bg-gray-800/10 backdrop-blur-[1px] z-20 hidden">
                        <i class="ph ph-spinner animate-spin text-5xl text-blue-600 drop-shadow-lg"></i>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- Error Message Toast -->
    <div id="error-message" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg hidden z-50 flex items-center gap-2">
        <i class="ph ph-warning-circle text-xl"></i>
        <span id="error-text">Error loading PDF</span>
    </div>

    <script>
        // State Variables
        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        let scale = 1.2; // Default zoom level
        const canvas = document.getElementById('pdf-render');
        const ctx = canvas.getContext('2d');
        
        // UI Elements
        const viewerContainer = document.getElementById('viewer-container');
        const emptyState = document.getElementById('empty-state');
        const pageNumSpan = document.getElementById('page-num');
        const pageCountSpan = document.getElementById('page-count');
        const pageLoader = document.getElementById('page-loader');
        const zoomLevelSpan = document.getElementById('zoom-level');
        
        /**
         * ব্লার ফিক্স করার মূল ফাংশন
         * High DPI স্ক্রিনের জন্য ক্যানভাস স্কেল অ্যাডজাস্ট করে
         */
        async function renderPage(num) {
            pageRendering = true;
            pageLoader.classList.remove('hidden');
            
            try {
                // Fetch page
                const page = await pdfDoc.getPage(num);
                
                const viewport = page.getViewport({ scale: scale });
                
                // --- BLUR FIX START ---
                // ডিভাইসের পিক্সেল রেশিও চেক করা (যেমন রেটিনা ডিসপ্লেতে এটি 2 বা 3 হতে পারে)
                const outputScale = window.devicePixelRatio || 1;

                // ক্যানভাসের আসল সাইজ বড় করা হচ্ছে পিক্সেল রেশিও অনুযায়ী
                canvas.width = Math.floor(viewport.width * outputScale);
                canvas.height = Math.floor(viewport.height * outputScale);

                // CSS এর মাধ্যমে ডিসপ্লে সাইজ আগের মতোই রাখা হচ্ছে
                canvas.style.width = Math.floor(viewport.width) + "px";
                canvas.style.height = Math.floor(viewport.height) + "px";

                // ট্রান্সফর্ম ম্যাট্রিক্স তৈরি করা যাতে রেন্ডার স্কেল অনুযায়ী হয়
                const transform = outputScale !== 1 
                    ? [outputScale, 0, 0, outputScale, 0, 0] 
                    : null;
                // --- BLUR FIX END ---

                const renderContext = {
                    canvasContext: ctx,
                    transform: transform, // এই ট্রান্সফর্ম প্যারামিটারটি খুবই গুরুত্বপূর্ণ
                    viewport: viewport
                };
                
                const renderTask = page.render(renderContext);

                // Wait for render to finish
                await renderTask.promise;
                
                pageRendering = false;
                pageLoader.classList.add('hidden');

                // Update UI stats
                pageNumSpan.textContent = num;
                updateButtons();

                if (pageNumPending !== null) {
                    renderPage(pageNumPending);
                    pageNumPending = null;
                }

            } catch (error) {
                console.error("Page render error:", error);
                pageRendering = false;
                pageLoader.classList.add('hidden');
            }
        }

        function queueRenderPage(num) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                renderPage(num);
            }
        }

        function onPrevPage() {
            if (pageNum <= 1) return;
            pageNum--;
            queueRenderPage(pageNum);
        }

        function onNextPage() {
            if (pageNum >= pdfDoc.numPages) return;
            pageNum++;
            queueRenderPage(pageNum);
        }

        function updateButtons() {
            document.getElementById('prev-page').disabled = pageNum <= 1;
            document.getElementById('next-page').disabled = pageNum >= pdfDoc.numPages;
        }

        function updateZoomDisplay() {
            zoomLevelSpan.textContent = `${Math.round(scale * 100)}%`;
        }

        function onZoomIn() {
            if(scale >= 3.0) return;
            scale += 0.2;
            updateZoomDisplay();
            queueRenderPage(pageNum);
        }

        function onZoomOut() {
            if(scale <= 0.4) return;
            scale -= 0.2;
            updateZoomDisplay();
            queueRenderPage(pageNum);
        }

        // Load PDF Function
        function loadPDF(data) {
            const loadingTask = pdfjsLib.getDocument(data);
            
            loadingTask.promise.then(function(pdfDoc_) {
                pdfDoc = pdfDoc_;
                pageCountSpan.textContent = pdfDoc.numPages;
                
                // Reset state
                pageNum = 1;
                scale = 1.2;
                updateZoomDisplay();
                
                // Show viewer, hide empty state
                viewerContainer.classList.remove('hidden-ui');
                emptyState.classList.add('hidden');
                
                renderPage(pageNum);
            }, function (reason) {
                // Error handling
                console.error(reason);
                showError("Invalid PDF file provided.");
            });
        }

        // Event Listeners
        document.getElementById('prev-page').addEventListener('click', onPrevPage);
        document.getElementById('next-page').addEventListener('click', onNextPage);
        document.getElementById('zoom-in').addEventListener('click', onZoomIn);
        document.getElementById('zoom-out').addEventListener('click', onZoomOut);

        // File Upload Handler
        document.getElementById('file-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(file && file.type === 'application/pdf') {
                const fileReader = new FileReader();
                fileReader.onload = function() {
                    const typedarray = new Uint8Array(this.result);
                    loadPDF(typedarray);
                };
                fileReader.readAsArrayBuffer(file);
            } else {
                showError("Please upload a valid PDF file.");
            }
        });

        // Helper: Show Error
        function showError(msg) {
            const errDiv = document.getElementById('error-message');
            const errText = document.getElementById('error-text');
            errText.textContent = msg;
            errDiv.classList.remove('hidden');
            setTimeout(() => errDiv.classList.add('hidden'), 3000);
        }

        // Keyboard Navigation
        document.addEventListener('keydown', (e) => {
            if (pdfDoc) {
                if (e.key === 'ArrowRight') onNextPage();
                if (e.key === 'ArrowLeft') onPrevPage();
                if (e.key === '+' || e.key === '=') onZoomIn();
                if (e.key === '-') onZoomOut();
            }
        });

    </script>

    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out' },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <!-- 2. JavaScript অংশ: এটি আপনার স্ক্রিপ্টের শেষে বা </body> ট্যাগের আগে পেস্ট করুন -->
<script>
    function jumpToSpecificPage() {
        // ইনপুট বক্স থেকে নাম্বার নেওয়া
        const input = document.getElementById('jumpToPageInput');
        const desiredPage = parseInt(input.value);

        // চেক করা হচ্ছে যে PDF লোড হয়েছে কিনা এবং পেজ নাম্বার সঠিক কিনা
        // 'pdfDoc' হলো আপনার গ্লোবাল ভেরিয়েবল (যদি নাম ভিন্ন হয় তবে পরিবর্তন করুন)
        if (typeof pdfDoc !== 'undefined' && pdfDoc) {
            if (desiredPage >= 1 && desiredPage <= pdfDoc.numPages) {
                
                // বর্তমান পেজ নম্বর আপডেট করা (আপনার কোডের ভেরিয়েবলের নাম অনুযায়ী 'pageNum' পরিবর্তন করতে হতে পারে)
                pageNum = desiredPage;

                // পেজ রেন্ডার ফাংশন কল করা (আপনার ফাংশনের নাম 'renderPage' না হলে এটি পরিবর্তন করুন)
                renderPage(pageNum); 
                
                // ইনপুট ফিল্ড ক্লিয়ার করা (অপশনাল)
                input.value = '';
            } else {
                alert(`অনুগ্রহ করে 1 থেকে ${pdfDoc.numPages} এর মধ্যে একটি নম্বর দিন।`);
            }
        } else {
            console.error("PDF Document not loaded or variable name mismatch.");
        }
    }
</script>

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .no-select { user-select: none; -webkit-user-select: none; }
        /* ক্যানভাস স্টাইল: সর্বোচ্চ শার্পনেসের জন্য */
        #pdf-render {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            background-color: white;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300 font-sans overflow-hidden selection:bg-blue-500 selection:text-white no-select">

    <!-- ================= HOME VIEW ================= -->
    <div id="home-view" class="flex h-screen w-full relative transition-opacity duration-300">
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-30 hidden opacity-0 transition-opacity duration-300 md:hidden" onclick="toggleSidebar(false)"></div>

        <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-72 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h1 class="text-2xl font-bold flex items-center gap-2">
                    <i class="ph-fill ph-book-open-text text-blue-600"></i> ই-লাইব্রেরি
                </h1>
                <button onclick="toggleSidebar(false)" class="md:hidden p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-700"><i class="ph ph-x text-xl"></i></button>
            </div>
            <nav class="p-4 space-y-2 flex-1 overflow-y-auto" id="category-list"></nav>
            <div class="p-4 text-xs text-center border-t border-gray-200 dark:border-gray-700 text-gray-500">বাম দিকে সোয়াইপ করে মেনু বন্ধ করুন</div>
        </aside>

        <div class="flex-1 flex flex-col h-screen overflow-hidden relative z-0 md:ml-0 w-full">
            <header class="bg-white dark:bg-gray-800 shadow-sm px-6 py-4 flex justify-between items-center z-20 transition-colors duration-300">
                <button class="md:hidden p-2 -ml-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" onclick="toggleSidebar(true)">
                    <i class="ph ph-list text-2xl text-gray-600 dark:text-gray-200"></i>
                </button>
                <div class="flex-1 max-w-xl mx-4 relative">
                    <i class="ph ph-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-lg"></i>
                    <input type="text" id="search-input" placeholder="বই খুঁজুন..." class="w-full pl-10 pr-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors bg-gray-50 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-900 dark:text-white placeholder-gray-400" oninput="handleSearch(this.value)">
                </div>
                <button onclick="toggleDarkMode()" class="p-2 rounded-full transition-colors transform hover:scale-110 duration-200 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-yellow-400 hover:bg-gray-200 dark:hover:bg-gray-600">
                    <i id="theme-icon" class="ph-fill ph-sun text-xl"></i>
                </button>
            </header>

            <main class="flex-1 overflow-y-auto p-6 scrollbar-hide">
                <div class="mb-6">
                    <h2 id="category-title" class="text-xl font-semibold">জনপ্রিয় বইসমূহ</h2>
                    <p id="book-count" class="text-sm mt-1 text-gray-500 dark:text-gray-400">লোড হচ্ছে...</p>
                </div>
                <div id="books-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-20"></div>
                <div id="empty-state" class="hidden flex-col items-center justify-center h-64 opacity-50">
                    <i class="ph ph-magnifying-glass text-5xl mb-4"></i>
                    <p>কোনো বই খুঁজে পাওয়া যায়নি।</p>
                </div>
            </main>
        </div>
    </div>

    <!-- ================= READER VIEW ================= -->
    <div id="reader-view" class="fixed inset-0 bg-gray-900 z-50 hidden flex-col h-screen w-full">
        
        <!-- Header -->
        <div id="reader-header" class="absolute top-0 left-0 right-0 z-30 transition-transform duration-300 translate-y-0">
            <div class="bg-gray-800/95 backdrop-blur text-white px-4 py-3 shadow-lg flex justify-between items-center border-b border-gray-700">
                <div class="flex items-center gap-3 overflow-hidden">
                    <button onclick="closeReader()" class="p-2 hover:bg-gray-700 rounded-full transition-colors"><i class="ph ph-caret-left text-xl"></i></button>
                    <div class="truncate">
                        <h2 id="reader-title" class="font-semibold text-sm md:text-base truncate">বইয়ের নাম</h2>
                        <p class="text-xs text-gray-400 flex items-center gap-2">
                            <span id="page-num">Page 1</span> / <span id="page-count">--</span>
                        </p>
                    </div>
                </div>
                <div class="flex items-center gap-2 md:gap-4">
                    <div class="relative">
                        <button onclick="toggleToc()" class="flex items-center gap-2 bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg text-sm transition-colors">
                            <i class="ph ph-list-bullets text-lg"></i>
                            <span class="hidden sm:inline">সূচিপত্র</span>
                            <i id="toc-icon" class="ph ph-caret-down text-sm transition-transform duration-200"></i>
                        </button>
                        <div id="toc-menu" class="absolute right-0 mt-2 w-64 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden z-50 max-h-[60vh] overflow-y-auto hidden">
                             <div class="p-3 bg-gray-100 dark:bg-gray-900 border-b dark:border-gray-700 font-semibold text-xs uppercase text-gray-500">অধ্যায় নির্বাচন করুন</div>
                             <div id="toc-list"></div>
                        </div>
                    </div>
                    <button onclick="toggleFullScreen()" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-white transition-colors" id="fs-btn"><i id="fs-icon" class="ph ph-corners-out text-lg"></i></button>
                    <div class="hidden lg:flex items-center gap-2 text-yellow-500 text-xs bg-yellow-500/10 px-3 py-1 rounded-full border border-yellow-500/20">
                        <i class="ph-fill ph-shield-warning"></i> <span>সুরক্ষিত</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- PDF Render Area -->
        <div class="flex-1 relative bg-gray-800 flex flex-col items-center pt-14 w-full h-full overflow-hidden"> 
            <div class="w-full h-full overflow-auto flex justify-center items-start py-4 px-2" id="pdf-container">
                <div class="relative">
                    <canvas id="pdf-render" class="max-w-full h-auto border border-gray-700"></canvas>
                    <!-- Watermark -->
                    <div class="absolute inset-0 pointer-events-none flex items-center justify-center opacity-[0.05] z-10">
                        <p class="text-4xl md:text-6xl font-bold rotate-45 text-black select-none">Protected View</p>
                    </div>
                    <!-- Loader -->
                    <div id="loader" class="absolute inset-0 flex items-center justify-center bg-gray-800 z-20">
                        <i class="ph ph-spinner animate-spin text-4xl text-blue-500"></i>
                    </div>
                </div>
            </div>
            <!-- Navigation -->
            <div class="absolute bottom-6 z-30 flex items-center gap-4 bg-gray-800/90 backdrop-blur px-6 py-3 rounded-full shadow-xl border border-gray-700 text-white">
                <button onclick="prevPage()" class="p-2 hover:bg-gray-700 rounded-full"><i class="ph ph-arrow-left"></i></button>
                <span class="text-sm font-mono"><span id="nav-page-num">1</span> of <span id="nav-page-count">--</span></span>
                <button onclick="nextPage()" class="p-2 hover:bg-gray-700 rounded-full"><i class="ph ph-arrow-right"></i></button>
                <!-- 1. HTML অংশ: যেখানে ইনপুট বক্স এবং বাটন দেখাতে চান সেখানে পেস্ট করুন -->
<div class="page-jump-controls" style="display: flex; gap: 5px; align-items: center; justify-content: center; margin: 10px 0;">
    <input type="number" id="jumpToPageInput" placeholder="Page" min="1" 
           style="background: #ffffff; color: #000000; padding: 5px; width: 60px; border: 1px solid #ddd; border-radius: 4px;">
    
    <button onclick="jumpToSpecificPage()" 
            style="padding: 5px 10px; background-color: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer;">
        Go
    </button>
</div>
                
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        const books = [
            {
                id: 1,
                title: "প্রোগ্রামিং এর হাতেখড়ি",
                author: "জন ডো",
                category: "Technology",
                coverColor: "bg-blue-600",
                chapters: [ { title: "সূচনা", page: 1 }, { title: "অধ্যায় ১", page: 2 } ],
                pdfUrl: "https://raw.githubusercontent.com/mozilla/pdf.js/ba2edeae/web/compressed.tracemonkey-pldi-09.pdf" 
            },
            {
                id: 2,
                title: "হিমু এবং এক বিকেলে",
                author: "হুমায়ূন আহমেদ",
                category: "Fiction",
                coverColor: "bg-yellow-600",
                chapters: [{ title: "শুরু", page: 1 }],
                pdfUrl: "https://pdfobject.com/pdf/sample.pdf"
            },
            {
                id: 3,
                title: "জাভাস্ক্রিপ্ট শিখুন",
                author: "কোডার ভাই",
                category: "Technology",
                coverColor: "bg-green-700",
                chapters: [{ title: "JS কি?", page: 1 }],
                pdfUrl: "https://raw.githubusercontent.com/mozilla/pdf.js/ba2edeae/web/compressed.tracemonkey-pldi-09.pdf"
            },
             {
                id: 4,
                title: "মহাকাশের অজানা কথা",
                author: "বিজ্ঞান ক্লাব",
                category: "Science",
                coverColor: "bg-purple-700",
                chapters: [{ title: "পরমাণু", page: 1 }],
                pdfUrl: "https://pdfobject.com/pdf/sample.pdf"
            }
        ];

        const categories = ["All", "Fiction", "Technology", "Science"];
        
        // --- STATE ---
        let currentCategory = "All";
        let searchQuery = "";
        let currentBook = null;
        let isDarkMode = true;
        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;

        const canvas = document.getElementById('pdf-render');
        const ctx = canvas.getContext('2d');

        // --- DOM ELEMENTS ---
        const dom = {
            html: document.documentElement,
            homeView: document.getElementById('home-view'),
            readerView: document.getElementById('reader-view'),
            booksGrid: document.getElementById('books-grid'),
            categoryList: document.getElementById('category-list'),
            categoryTitle: document.getElementById('category-title'),
            bookCount: document.getElementById('book-count'),
            sidebar: document.getElementById('sidebar'),
            sidebarOverlay: document.getElementById('sidebar-overlay'),
            emptyState: document.getElementById('empty-state'),
            themeIcon: document.getElementById('theme-icon'),
            readerTitle: document.getElementById('reader-title'),
            loader: document.getElementById('loader'),
            tocList: document.getElementById('toc-list'),
            tocMenu: document.getElementById('toc-menu'),
            tocIcon: document.getElementById('toc-icon')
        };

        // --- INIT ---
        function init() {
            renderCategories();
            renderBooks();
            setupSecurity();
            setupSwipe();
            updateThemeIcon();
        }

        function renderCategories() {
            dom.categoryList.innerHTML = `<h2 class="text-xs font-semibold uppercase tracking-wider mb-4 ${isDarkMode ? 'text-gray-400' : 'text-gray-500'}">ক্যাটাগরি সমূহ</h2>`;
            categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = `w-full text-left px-4 py-3 rounded-lg transition-all duration-200 mb-1 ${currentCategory === cat ? 'bg-blue-600 text-white font-medium shadow-md translate-x-1' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'}`;
                btn.textContent = cat === 'All' ? 'সকল বই' : cat;
                btn.onclick = () => { currentCategory = cat; toggleSidebar(false); renderCategories(); renderBooks(); };
                dom.categoryList.appendChild(btn);
            });
        }

        function renderBooks() {
            dom.booksGrid.innerHTML = '';
            const filtered = books.filter(b => (currentCategory === "All" || b.category === currentCategory) && (b.title.toLowerCase().includes(searchQuery.toLowerCase()) || b.author.toLowerCase().includes(searchQuery.toLowerCase())));
            dom.categoryTitle.textContent = currentCategory === 'All' ? 'জনপ্রিয় বইসমূহ' : `${currentCategory} এর বইসমূহ`;
            dom.bookCount.textContent = `মোট ${filtered.length} টি বই পাওয়া গেছে`;
            
            if (filtered.length === 0) { dom.emptyState.classList.remove('hidden'); dom.emptyState.classList.add('flex'); return; }
            else { dom.emptyState.classList.add('hidden'); dom.emptyState.classList.remove('flex'); }

            filtered.forEach((book, index) => {
                const card = document.createElement('div');
                card.className = `group rounded-xl shadow-sm hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 overflow-hidden border flex flex-col animate-fade-in bg-white dark:bg-gray-800 border-gray-100 dark:border-gray-700`;
                card.style.animationDelay = `${index * 100}ms`;
                card.innerHTML = `
                    <div class="h-48 w-full ${book.coverColor} flex flex-col items-center justify-center relative cursor-pointer overflow-hidden p-4 text-center" onclick="openReader(${book.id})">
                        <div class="absolute inset-0 bg-black/20 group-hover:bg-black/40 transition-colors duration-300"></div>
                        <h3 class="relative z-10 text-white font-bold text-lg mb-3 line-clamp-2 leading-tight drop-shadow-md">${book.title}</h3>
                        <div class="relative z-10 bg-white/20 backdrop-blur-sm border border-white/50 text-white px-4 py-1.5 rounded-full text-sm font-medium group-hover:bg-white group-hover:text-gray-900 transition-all duration-300 shadow-sm flex items-center gap-2">
                            <i class="ph-bold ph-book-open"></i> ওপেন করুন
                        </div>
                    </div>
                    <div class="p-4 flex-1 flex flex-col justify-between">
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs text-blue-500 font-semibold uppercase bg-blue-50 dark:bg-blue-900/30 px-2 py-0.5 rounded">${book.category}</span>
                            </div>
                            <p class="text-sm text-gray-500 dark:text-gray-400 flex items-center gap-1"><i class="ph-fill ph-user"></i> ${book.author}</p>
                        </div>
                    </div>
                `;
                dom.booksGrid.appendChild(card);
            });
        }

        // --- PDF RENDER LOGIC (HIGH RES FIX) ---
        function openReader(bookId) {
            const book = books.find(b => b.id === bookId);
            if (!book) return;
            currentBook = book;
            
            dom.readerTitle.textContent = book.title;
            dom.homeView.classList.add('hidden');
            dom.readerView.classList.remove('hidden');
            dom.readerView.classList.add('flex');
            dom.loader.classList.remove('hidden');

            dom.tocList.innerHTML = '';
            book.chapters.forEach(chap => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 text-sm text-gray-800 dark:text-gray-200 border-b border-gray-100 dark:border-gray-700 last:border-0 flex justify-between";
                btn.innerHTML = `<span>${chap.title}</span><span class="text-xs text-gray-400 bg-gray-200 dark:bg-gray-900 px-2 py-0.5 rounded">P. ${chap.page}</span>`;
                btn.onclick = () => { queueRenderPage(chap.page); toggleToc(); };
                dom.tocList.appendChild(btn);
            });

            pdfjsLib.getDocument(book.pdfUrl).promise.then(function(pdfDoc_) {
                pdfDoc = pdfDoc_;
                document.getElementById('page-count').textContent = pdfDoc.numPages;
                document.getElementById('nav-page-count').textContent = pdfDoc.numPages;
                pageNum = 1;
                renderPage(pageNum);
                dom.loader.classList.add('hidden');
            }).catch(function(error) {
                console.error('Error loading PDF:', error);
                dom.loader.classList.add('hidden');
                alert("PDF লোড করা যাচ্ছে না।");
            });
        }

        function renderPage(num) {
            pageRendering = true;
            
            pdfDoc.getPage(num).then(function(page) {
                const container = document.getElementById('pdf-container');
                // কন্টেইনারের আসল প্রস্থ বের করা (প্যাডিং বাদ দিয়ে)
                const containerWidth = container.clientWidth - 30; 
                
                // ১. পেজের ডিফল্ট ভিউপোর্ট নেওয়া
                const unscaledViewport = page.getViewport({scale: 1});
                // ২. কন্টেইনারের সাথে ফিট করার জন্য স্কেল হিসাব করা
                const scale = containerWidth / unscaledViewport.width;

                // ৩. High DPI বা Retina স্ক্রিনের জন্য পিক্সেল রেশিও চেক করা
                const outputScale = window.devicePixelRatio || 1;

                // ৪. আসল ভিউপোর্ট তৈরি করা (স্কেল অনুযায়ী)
                const viewport = page.getViewport({scale: scale});

                // ৫. ক্যানভাসের ইন্টারনাল রেজোলিউশন বাড়ানো (High Quality)
                canvas.width = Math.floor(viewport.width * outputScale);
                canvas.height = Math.floor(viewport.height * outputScale);

                // ৬. CSS দিয়ে ডিসপ্লে সাইজ ঠিক রাখা (যাতে স্ক্রিনের বাইরে না যায়)
                canvas.style.width = Math.floor(viewport.width) + "px";
                canvas.style.height = Math.floor(viewport.height) + "px";

                // ৭. রেন্ডার করার সময় স্কেল ট্রান্সফর্ম করা (যাতে ব্লার না হয়)
                const transform = outputScale !== 1 
                  ? [outputScale, 0, 0, outputScale, 0, 0] 
                  : null;

                const renderContext = {
                    canvasContext: ctx,
                    transform: transform,
                    viewport: viewport
                };
                
                const renderTask = page.render(renderContext);

                renderTask.promise.then(function() {
                    pageRendering = false;
                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });
            });

            document.getElementById('page-num').textContent = `Page ${num}`;
            document.getElementById('nav-page-num').textContent = num;
        }

        function queueRenderPage(num) { pageRendering ? pageNumPending = num : renderPage(num); }
        function prevPage() { if (pageNum <= 1) return; pageNum--; queueRenderPage(pageNum); }
        function nextPage() { if (pageNum >= pdfDoc.numPages) return; pageNum++; queueRenderPage(pageNum); }
        function closeReader() { dom.readerView.classList.add('hidden'); dom.readerView.classList.remove('flex'); dom.homeView.classList.remove('hidden'); pdfDoc = null; ctx.clearRect(0, 0, canvas.width, canvas.height); }
        function handleSearch(val) { searchQuery = val; renderBooks(); }
        function toggleSidebar(show) { isSidebarOpen = show; dom.sidebar.classList.toggle('-translate-x-full', !show); dom.sidebarOverlay.classList.toggle('hidden', !show); setTimeout(() => dom.sidebarOverlay.classList.toggle('opacity-0', !show), 10); }
        function toggleDarkMode() { isDarkMode = !isDarkMode; dom.html.classList.toggle('dark', isDarkMode); updateThemeIcon(); renderCategories(); }
        function updateThemeIcon() { dom.themeIcon.className = isDarkMode ? 'ph-fill ph-sun text-xl' : 'ph-fill ph-moon text-xl'; }
        function toggleToc() { dom.tocMenu.classList.toggle('hidden'); dom.tocIcon.classList.toggle('rotate-180'); }
        function toggleFullScreen() { if (!document.fullscreenElement) dom.readerView.requestFullscreen().catch(e=>alert(e)); else document.exitFullscreen(); }
        
        function setupSecurity() {
            document.addEventListener('contextmenu', e => e.preventDefault());
            document.addEventListener('keydown', e => { if ((e.ctrlKey && ['p', 's', 'u'].includes(e.key)) || e.key === 'F12') e.preventDefault(); });
        }
        let touchStartX = 0;
        function setupSwipe() { dom.sidebar.addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX); dom.sidebar.addEventListener('touchend', e => { if (touchStartX - e.changedTouches[0].screenX > 50) toggleSidebar(false); }); }

        init();
    </script>
</body>
</html>

